# Справляемся с перегрузками
## Ловушки понятия «запросов в секунду»
Стоимость запроса может изменяться в зависимости от произвольных факторов. Постоянно изменяющаяся величина — плохой показатель для балансировки нагрузки.
Более удачный вариант — измерять производительность непосредственно в доступных ресурсах. Обычно, утилизация CPU.

## Лимиты потребителей
Сумма лимитов может быть больше реальных рессурсов, если одновременный запрос всеми пользователями маловероятен.

## Регулирование на стороне клиента
Отклонение запросов на стороне бэкенда все ещё потребляет часть ресурсов. Эффективнее контроллировать лимиты на стороне клиента. Для этого применятся "адаптивное регулирование": клиент сохраняет статистику успешных и отклоненных запросов, если отклонённых запросов много - ограничивает себя.

## Критичность
Бэкенд отклоняет запросы с учетом приоритетов `CRITICAL_PLUS`, `CRITICAL`, `SHEDDABLE_PLUS`, `SHEDDABLE`

## Сигналы загруженности
...

## Обработка ошибок, связанных с перегрузкой
Две основные ситуации: большое или небольшое подмножество задач бэкенда в дата-центре перегружено. В первом случае, запросы повторять не нужно и на вызывающей стороне должны появиться ошибки. Во втором, можно повторить.
### Решаем выполнить повторную попытку
Должен быть бюджет повторных попыток для отдельных запросов и для клиента в целом. Если счетчик попыток отправлять от клиента с запросом, бэкенд сможет понять - перегружены ли другие реплики, чтобы ответить "перегуржен, не повторять" вместо просто "перегружен".

## Нагрузка от соединений
...
