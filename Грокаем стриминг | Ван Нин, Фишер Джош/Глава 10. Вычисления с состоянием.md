# Глава 10. Вычисления с состоянием
## Миграция стриминговых заданий
## Компоненты с состоянием в задании контроля за использованием системы
## Снова о состоянии
## Состояния в разных компонентах
## Данные состояния и временные данные
Cостояние экземпляра включает только ключевые данные, чтобы экземпляр можно было развернуть в предыдущем состоянии и он мог продолжить нормально работать. Временные данные, например кэш, в стриминговых системах обычно не считаются данными состояния.
## Компоненты с состоянием и без состояния: код
## Источник с состоянием и оператор в задании контроля за использованием системы
## Состояния и контрольные точки
## Создание контрольных точек: сложность выбора момента времени
Чтобы избежать проблемы рассинхронизации и сохранить правильность результатов, вместо сохранения состояний в один и тот же момент физического времени все экземпляры должны сохранять свои состояния в один и тот же момент _событийного времени_: сразу же после обработки одной и той же транзакции.
## Событийный отсчет времени
При создании контрольных точек в стриминговых системах время измеряется не по часам, а по идентификатору события.
## Создание контрольных точек с использованием событий контрольных точек
Управляющие события не содержат данных для обработки. Вместо этого в них передаются данные, при помощи которых все модули в стриминговом задании взаимодействуют друг с другом. В случае контрольных точек используется событие контрольной точки, обязанностью которого становится оповещение всех экземпляров стримингового задания о том, что пришло время создать контрольную точку.
## Событие контрольной точки обрабатывается исполнителями экземпляров
## Путь события контрольной точки через задание
## Создание контрольных точек с использованием событий контрольных точек на уровне экземпляров
Когда диспетчер событий получает событие контрольной точки от предшествующего компонента, он направляет по одной копии события каждому экземпляру последующего компонента. С другой стороны, событие данных обычно получает только один экземпляр последующего компонента.
## Синхронизация событий контрольных точек
## Загрузка контрольных точек и обратная совместимость
Если логика существующих компонентов с состоянием изменится, разработчики должны позаботиться о том, чтобы новая реализация работала с прежними контрольными точками для правильного восстановления состояний экземпляров.
Точки сохранения - особая разновидность контрольных точек. Они похожи на обычные контрольные точки, но активируются вручную, и разработчик имеет больше возможностей для управления ими.
## Хранилище контрольных точек
Для повышения надежности стриминговых систем в хранилище обычно оставляют N последних контрольных точек, а более старые точки удаляют. Если самая последняя контрольная точка не настраивается, диспетчер контрольных точек выполняет откат к предыдущей контрольной точке и пытается восстановить стриминговое задание.
## Компоненты с состоянием и компоненты без состояния
Только компоненты с состояние позволяют реализовать семантику "ровно один", но:
1. Откат к предыдущему состоянию в случае ошибок требует времени
2. Приходится поддерживать больше процессов. 
3. Из-за управления контрольными точками снижается пропускная способность.
4. Необходимо реализовать управление состоянием экземляров.
5. Необходимо хранилище контрольных точек.
## Ручное управление состоянием экземпляров
## Лямбда-архитектура
Идея лямбда-архитектуры весьма проста: стриминговое задание и пакетное задание выполняются параллельно с одними и теми же данными событий. В такой архитектуре стриминговое задание отвечает за генерирование результатов в реальном времени, которые в основном точны, но при возникновении проблем точность не гарантирована; с другой стороны, пакетное задание отвечает за генерирование точных результатов с более высокой задержкой.

С лямбда-архитектурой приходится строить и обслуживать две системы, а представить два набора результатов довольно сложно. Тем не менее требование к точности стримингового задания может быть менее жестким, и задание может работать именно над тем, для чего оно разрабатывалось и с чем особенно хорошо справляется, — над обработкой событий в реальном времени.

_Spark позволяет использовать один код и для потоковой, и для пакетной обработки_
## Итоги
## Упражнения
> Если преобразовать задание контроля за использованием системы в задание без состояния, каковы будут достоинства и недостатки такого решения? Можно ли улучшить его, вручную управляя состоянием экземпляров? И что произойдет в случае аппаратного сбоя, когда экземпляры будут перезапущены на других машинах?
...

> Задание обнаружения мошеннических действий оптимизировано для обработки в реальном времени из-за требований к задержке. Каковы его достоинства и недостатки и как его можно усовершенствовать с применением лямбда-архитектуры?
...