# Глава 7. Оконные вычисления
## Сегментация данных в реальном времени
## Анализ речи
Транзакция считается мошеннической, если совершена на большом расстоянии от предыдущей, куда невозможно было добраться даже на самолёте.
## Анализ речи (продолжение)
Нужно отслеживать поведение всех карт, а не одной отдельной.
## Два разных контекста
Один проверяет случаи использования в контексте отдельной карты. Другой - в контексте всех карт, используемых в одной точке.
## Окна в задании обнаружения мошеннических действий
В этой главе будет расмотрен только первый вариант.
## Что именно называется окном?
Окно - сегмент потока данных. Сегментация можно быть основана как на времени, так и на количестве событий.
## Подробнее об окнах
До сих пор каждый элемент обрабатывался по отдельности. В этой главе события будут обрабатываться по группам, которые формируются окнами. Размер окна может определяться периодом времени или количеством элментов - по выбору разработчика.
## Новая концепция: оконная стратегия
Существует три типа оконных стратегий: фиксированное окно, скользящее и сеансовое.
## Фиксированные окна
Самая простая стратегия. Иногда называют переворачивающимися окнами (tumbling windows). Соыбтия группируются в пакет, который обрабатывается как единое целое. Например, все события за 1 минуту.
## Фиксированные окна в анализаторе оконного состояния
## Обнаружение попыток мошенничества в фиксированном врменном окне
Фиксированные окна не подходят для этой задачи, так как транзации по одной карте могут попасть в разные сегменты, даже если между ними совсем небольшой промежуток времени.
## Фиксированные окна: время и количество
Временные окна определяеются неизменяемым интервалом времени. Количественные - количеством событий.
## Скользящие окна
Они же sliding windows. От фиксированных отличаются интервалом смещения (slide interval). Новое окно создаётся не при завершении предыдущего, а через каждый интервал смещения. Интервалы окна и смещения позволяют окнам перекрываться, из-за чего каждое событие может быть включено в несколько окон.
## Скользящие окна: анализатор оконного расстояния
## Обнаружение мошеннических действий благодаря использованию скользящих окон
## Сеансовые окна
Сеансом (session) называется период активности, ограниченный определенными промежутками отсутствия активности. Сеан может использоваться для группировки событий.
## Сеансовые окна (продолжение)
Обычно сеансовые окна определяются тайм-аутом - максимальным промежутком времени, в течении которого сеанс может оставаться открытым.
## Обнаружение мошеннических действий благодаря использованию сеансовых окон
## Обзор оконных стратегий
- Фиксированные окна имеют фиксированный размер, и новое окно отрывается при закрытии предыдущего. Окна не пересекаются.
- Скользящие окна имеют одинаковый фиксированный размер, но новое окно открывается до закрытия предыдущего. Таким образом, окна пересекаются.
- Сеансовые окна обычно отслеживаются для каждого ключа по отдельности. Каждое окно открывается и закрывается по промежутку отсутствия активности.
## Разбиение потока событий на наборы данных
В оконных операторах события разбиваются на наборы, упаковываются в объекты `EventWindow` ядром и отправляются для обработки операторам, определяемым пользователем. Каждый объект `EventWindow` также включает информацию о времени - например, начало и конец окна.
## Оконные системы: концепция и реализация
Для решения задачи обнаружения мошенических действий не подходит ни одна стратегия. Окна будут слишком большие, их будет сложно обработать. К тому же задержка будет больше требуемых 20мс.
## Другой взгляд
Достаточно знать только одну предыдущую транзакцию.
## Хранилища пар "ключ - значение"
В хранилище пар "ключ - значение" каждая запись ассоциируется с уникальным ключом.
Его можно использовать для реализации оконной стратегии.
## Реализация анализатора оконного расстояния
Ключом будет номер карты, а значение - время и место транзакции. При обработке каждой новой транзакции предыдущая подгружается из хранилища. После новая транзакция замещает предыдущую в хранилище.
## Время события и другие вехи
Временем события считается момент его создания.
## Водяной знак окна
Если окно закрывается точно в конце временного окна, некоторые события могут не успеть в него попасть. Чтобы решить эту проблему, можно держать окно открытым чуть дольше и ждать получения событий. Дополнительное время ожидания для окна обычно называется водяным знаком (windowing watermark).
## Поздние события
События, полученные после закрытия соотвествующего окна, называются поздними событиями.
## Итоги
Расмотрели три основные оконные стратегии и научились моделировать их с помощью K-V хранилищ.
## Упражнения
> Как бы вы стали выявлять подозрительные бензоколонки, чтобы заблокировать обработку кредитных карт на них?

Буду считать колонку подозрительной, если на ней происходит много транзакций в короткий период. Для этого в K-V буду хранить последнюю транзакцию для каждой колонки. При обработке новой транзакции смотреть: если прошло меньше минуты - колонка блокируется.