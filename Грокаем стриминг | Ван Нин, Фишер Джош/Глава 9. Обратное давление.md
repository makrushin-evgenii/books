# Глава 9. Обратное давление
## Надежность критична
## Обзор системы
## Усовершенствование стриминговых заданий
## Новые концепции: мощность, использование и резерв мощности
Мощность (capacity) — максимальное количество событий, которое может быть обработано экземпляром.
Использование мощности (capacity utilization) — отношение фактического количества обрабатываемых событий к мощности.
Резерв мощности (capacity headroom) — показатель, обратный использованию.
## Подробнее об использовании и резерве мощности
Когда использование достигает 100%, экземпляр становится полностью загруженным и следующей защитной мерой становится обратное давление.
В стриминговом задании разные экземпляры могут иметь разные резервы мощности. Вообще говоря, резерв мощности компонента определяется минимальным резервом мощности всех его экземпляров; а резерв задания равен минимальному резерву всех экземпляров в задании. В идеале резервы мощности всех экземпляров в задании должны быть примерно одинаковы.
## Новая концепция: обратное давление
Целью обратного давления является замедление входящего трафика, если трафик превышает возможности системы по его обработке. Представляет собой давление в направлении, обратном направлению течения данных — от последующих экземпляров к предшествующим.
## Измерение использования мощности
Можно понять по росту входящей очереди. Если она растёт непрерырвно, и превышает заданный предел - значит экземпляр не справляется с её обработкой.
## Обратное давление в ядре Streamwork
Когда очередь заполняется, входящие транзакции будут блокироваться, пока последующий экземпляр не присвоит новые элементы из очереди. Так скорость обработки замедляется до скорости самого медленного экземпляра.
## Обратное давление в ядре Streamwork: распространение
При наличии нескольких предшествующих компонентом замедлится работа всех этих экземпляров потому что все они будут направлять события в одну блокирующую очередь.
## Стриминговое задание с обратным давлением
## Обратное давление в распределенных системах
В распределенных системах обнаружение и реализация обратного давления сложнее. Для обнаружение занятых экземпляров смотрят количество событий в очереди или размер памяти, занимаемой событиями в очереди. А чтобы занятый экземпляр получил ресурс мощности, останаваливают экземпляры предшествующих компонентом или останавливают экземпляры источников. Иногда используют отбрасывание событий - если потеря приемлема, а скорость критична.
## Новая концепция: водяные знаки обратного давления
Водяные знаки обратного давления представляют собой верхний и нижний уровни использования промежуточных очередей между процессами. Когда размер очереди выше верхнего, система должна перейти в состояние обратного давления. Если обратное давление активно, а размер очереди стал меньше нижнего уровня - обратное давление можно снять.
## Другой подход к управлению отстающими экземплярами: отбрасывание событий
Если очередь содержит слишком много событий, новые будут просто отбрасываться.
## Когда отбрасывание событий допустимо?
## Обратное давление как возможный симптом
## Останов и возобновление работы могут привести к пробуксовке
Пробуксовка - циклическиок объявление и снятие обратного давления.
## Решение проблемы пробуксовки
Возможно, поток от источника повысился до постоянного уровня, с которым задание не справляется. Его нужно масштабировать. Или скорость обработки снизилась. Нужно их проверить.
## Итоги
Обратное давление возникает когда экземпляр не успевает обрабатывать входящие события. Стриминговые системы понимают это по росту входящей очереди. Используется остановка входящего трафика, если важно сохранить точность, или отбрасывание событий - если важнее сохранить скорость.